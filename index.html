<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Radio Barry</title>
  <style>
    :root{
      --bg: #0b0f18;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);
      --line: rgba(255,255,255,.12);
      --accent: #6aa9ff;
      --accent2: #8bd3ff;
      --good: #4ee1a0;
      --warn: #ffcc66;
      --bad: #ff6b6b;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 700px at 30% -10%, rgba(106,169,255,.25), transparent 55%),
                  radial-gradient(900px 600px at 90% 10%, rgba(139,211,255,.18), transparent 50%),
                  linear-gradient(180deg, #070a12, #0b0f18 30%, #070a12);
      min-height: 100vh;
    }

    header{
      padding: 18px 18px 10px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .title{
      display:flex;
      align-items:baseline;
      gap:12px;
    }
    .title h1{
      margin:0;
      font-size: 20px;
      letter-spacing:.2px;
    }
    .title .sub{
      font-size: 13px;
      color: var(--muted2);
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 18px 28px;
      display: grid;
      gap: 14px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 980px){
      main{
        grid-template-columns: 420px 1fr;
        align-items: start;
      }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card .inner{ padding: 16px; }

    .now{
      display:flex;
      gap: 14px;
      align-items:center;
    }
    .station-logo{
      width: 64px;
      height: 64px;
      border-radius: 16px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex: 0 0 auto;
    }
    .station-logo img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .now-meta{ min-width:0; flex: 1 1 auto; }
    .now-meta .name{
      font-size: 16px;
      font-weight: 650;
      margin: 0 0 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .now-meta .line{
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
    }
    .dot{
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--muted2);
    }
    .dot.on{ background: var(--good); }
    .dot.err{ background: var(--bad); }
    .dot.warn{ background: var(--warn); }

    .controls{
      display:flex;
      gap:10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(106,169,255,.22), rgba(106,169,255,.12));
      border-color: rgba(106,169,255,.35);
    }
    .btn.small{
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 11px;
    }

    .row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 12px 16px;
      border-top: 1px solid var(--line);
      background: rgba(0,0,0,0);
    }
    .row .label{
      font-size: 13px;
      color: var(--muted2);
    }

    .vol{
      width: 160px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    input[type="range"]{
      width: 100%;
    }

    .qualities{
      display:flex;
      gap:8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .pill{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      user-select:none;
    }
    .pill.active{
      border-color: rgba(106,169,255,.55);
      background: rgba(106,169,255,.16);
    }

    .list-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .list-head h2{
      margin:0;
      font-size: 14px;
      letter-spacing: .2px;
      color: rgba(255,255,255,.88);
    }
    .search{
      width: 220px;
      max-width: 55vw;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 13px;
      outline: none;
    }

    .station-list{
      max-height: 68vh;
      overflow:auto;
    }
    @media (min-width: 980px){
      .station-list{ max-height: calc(100vh - 190px); }
    }

    .item{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      cursor:pointer;
      background: rgba(0,0,0,0);
      transition: background .15s ease;
    }
    .item:hover{ background: rgba(255,255,255,.04); }
    .item.active{
      background: rgba(106,169,255,.10);
      outline: 1px solid rgba(106,169,255,.25);
    }

    .num{
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 12px;
      color: var(--muted);
      flex: 0 0 auto;
    }

    .mini-logo{
      width: 42px;
      height: 42px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      flex: 0 0 auto;
    }
    .mini-logo img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .item-meta{ min-width:0; flex: 1 1 auto; }
    .item-meta .n{
      font-size: 14px;
      font-weight: 650;
      margin:0 0 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item-meta .s{
      font-size: 12px;
      color: var(--muted2);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .star{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.85);
      width: 38px;
      height: 38px;
      border-radius: 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      user-select:none;
      flex: 0 0 auto;
    }
    .star.on{
      border-color: rgba(255,212,106,.55);
      background: rgba(255,212,106,.12);
    }

    .footnote{
      padding: 12px 16px;
      font-size: 12px;
      color: var(--muted2);
    }
    a{ color: var(--accent2); }
  </style>
</head>

<body>
  <header>
    <div class="title">
      <h1>Radio Barry</h1>
      <div class="sub">Cloudflare Pages</div>
    </div>
  </header>

  <main>
    <!-- LEFT: PLAYER -->
    <section class="card" aria-label="Player">
      <div class="inner">
        <div class="now">
          <div class="station-logo" id="nowLogo" aria-hidden="true"></div>
          <div class="now-meta">
            <div class="name" id="nowName">Kies een zender</div>
            <div class="line" id="nowInfo">Klaar om te spelen</div>
            <div class="tag">
              <span class="dot" id="statusDot"></span>
              <span id="statusText">Idle</span>
            </div>
          </div>
        </div>

        <div class="controls">
          <button class="btn small" id="prevBtn" title="Vorige">◀</button>
          <button class="btn primary" id="playBtn" title="Play/Pause">Play</button>
          <button class="btn small" id="nextBtn" title="Volgende">▶</button>
          <button class="btn small" id="stopBtn" title="Stop">Stop</button>

          <div class="vol" title="Volume">
            <span style="font-size:12px;color:var(--muted2)">Vol</span>
            <input id="vol" type="range" min="0" max="100" value="85" />
          </div>
        </div>

        <div class="qualities" id="qualities"></div>
      </div>

      <div class="row">
        <div class="label">Tip</div>
        <div style="font-size:13px;color:var(--muted)">
          Klik op een zender (of logo) om direct te spelen.
        </div>
      </div>
    </section>

    <!-- RIGHT: LIST -->
    <section class="card" aria-label="Zenders">
      <div class="list-head">
        <h2>Zenders</h2>
        <input class="search" id="search" placeholder="Zoek…" />
      </div>
      <div class="station-list" id="list"></div>
      <div class="footnote">
        Stream via Pages Functions: <code>/api/stream</code> en metadata via <code>/api/icy</code>.
      </div>
    </section>
  </main>

  <script>
    // Pages Functions endpoints
    const STREAM_PROXY_BASE = "/api/stream?url=";
    const ICY_BASE = "/api/icy?url=";

    // LocalStorage keys
    const LS_FAVS = "radio-barry:favs:v1";
    const LS_LAST = "radio-barry:lastStationId:v1";
    const LS_LAST_STREAM = "radio-barry:lastStreamUrl:v1";
    const LS_LAST_VOL = "radio-barry:vol:v1";

    // Your station list (numbering is based on this order)
    // NPO Radio 1 on top, and no "IJselstein" text.
    const stations = [
      {
        id: "npo1",
        name: "NPO Radio 1",
        logo: "logos/npo-radio-1.png",
        fixedStreams: [
          { url: "https://icecast.omroep.nl/radio1-bb-mp3", bitrate: 128, codec: "mp3" }
        ]
      },
      {
        id: "npo2",
        name: "NPO Radio 2",
        logo: "logos/npo-radio-2.png",
        fixedStreams: [
          { url: "https://icecast.omroep.nl/radio2-bb-mp3", bitrate: 128, codec: "mp3" }
        ]
      },
      {
        id: "npo3fm",
        name: "NPO 3FM",
        logo: "logos/npo-3fm.png",
        fixedStreams: [
          { url: "https://icecast.omroep.nl/3fm-bb-mp3", bitrate: 128, codec: "mp3" }
        ]
      },
      {
        id: "npo4",
        name: "NPO Klassiek",
        logo: "logos/npo-klassiek.png",
        fixedStreams: [
          { url: "https://icecast.omroep.nl/radio4-bb-mp3", bitrate: 128, codec: "mp3" }
        ]
      },
      {
        id: "npo5",
        name: "NPO Radio 5",
        logo: "logos/npo-radio-5.png",
        fixedStreams: [
          { url: "https://icecast.omroep.nl/radio5-bb-mp3", bitrate: 128, codec: "mp3" }
        ]
      },
      {
        id: "npo-soul",
        name: "NPO Soul & Jazz",
        logo: "logos/npo-soul-jazz.png",
        fixedStreams: [
          { url: "https://icecast.omroep.nl/radio6-bb-mp3", bitrate: 128, codec: "mp3" }
        ]
      },
      {
        id: "sublime",
        name: "Sublime",
        logo: "logos/sublime.png",
        fixedStreams: [
          { url: "https://stream.sublime.nl/Sublime", bitrate: 192, codec: "mp3" }
        ]
      },
      {
        id: "100p",
        name: "100% NL",
        logo: "logos/100pnl.png",
        fixedStreams: [
          { url: "https://stream.100p.nl/100pctnl.mp3", bitrate: 192, codec: "mp3" }
        ]
      },
      {
        id: "pure-worship",
        name: "Pure Worship Radio",
        logo: "logos/pure-worship.png",
        fixedStreams: [
          // Deze werkt bij jou nu goed
          { url: "https://pureworshipradio.com/stream", bitrate: 128, codec: "mp3" }
        ]
      },
      {
        id: "mooiste-muziek",
        name: "De Mooiste Muziek",
        logo: "logos/mooiste-muziek.png",
        fixedStreams: [
          { url: "https://stream.de-mooiste-muziek.nl/stream.mp3", bitrate: 128, codec: "mp3" }
        ]
      }
    ];

    // Audio setup
    const audio = new Audio();
    audio.crossOrigin = "anonymous";
    audio.preload = "none";

    // UI refs
    const nowLogo = document.getElementById("nowLogo");
    const nowName = document.getElementById("nowName");
    const nowInfo = document.getElementById("nowInfo");
    const statusDot = document.getElementById("statusDot");
    const statusText = document.getElementById("statusText");
    const playBtn = document.getElementById("playBtn");
    const stopBtn = document.getElementById("stopBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const vol = document.getElementById("vol");
    const qualitiesEl = document.getElementById("qualities");
    const listEl = document.getElementById("list");
    const searchEl = document.getElementById("search");

    let favs = loadFavs();
    let filteredStations = [...stations];

    let currentIndex = 0;
    let currentStation = stations[0];
    let currentStreams = [];
    let selectedStreamUrl = "";

    let icyTimer = null;

    function setStatus(kind, text){
      statusDot.classList.remove("on","err","warn");
      if(kind === "on") statusDot.classList.add("on");
      if(kind === "err") statusDot.classList.add("err");
      if(kind === "warn") statusDot.classList.add("warn");
      statusText.textContent = text;
    }

    function loadFavs(){
      try{
        const raw = localStorage.getItem(LS_FAVS);
        return raw ? new Set(JSON.parse(raw)) : new Set();
      }catch{
        return new Set();
      }
    }
    function saveFavs(){
      localStorage.setItem(LS_FAVS, JSON.stringify([...favs]));
    }

    function saveLast(){
      localStorage.setItem(LS_LAST, currentStation.id);
      if(selectedStreamUrl) localStorage.setItem(LS_LAST_STREAM, selectedStreamUrl);
    }

    function loadLast(){
      const lastId = localStorage.getItem(LS_LAST);
      if(!lastId) return;
      const idx = stations.findIndex(s => s.id === lastId);
      if(idx >= 0){
        currentIndex = idx;
        currentStation = stations[idx];
      }
      const lastStream = localStorage.getItem(LS_LAST_STREAM);
      if(lastStream) selectedStreamUrl = lastStream;
    }

    function renderNow(){
      nowName.textContent = currentStation?.name || "Kies een zender";
      nowLogo.innerHTML = "";
      if(currentStation?.logo){
        const img = document.createElement("img");
        img.src = currentStation.logo;
        img.alt = currentStation.name;
        nowLogo.appendChild(img);
      }else{
        nowLogo.textContent = "♪";
      }
    }

    function formatKbps(x){
      if(!x) return "";
      return `${x} kb/s`;
    }

    function renderQualities(){
      qualitiesEl.innerHTML = "";
      if(!currentStreams.length){
        const span = document.createElement("span");
        span.style.color = "var(--muted2)";
        span.style.fontSize = "12px";
        span.textContent = "Geen streams gevonden.";
        qualitiesEl.appendChild(span);
        return;
      }

      for(const s of currentStreams){
        const pill = document.createElement("button");
        pill.className = "pill" + (s.url === selectedStreamUrl ? " active" : "");
        pill.textContent = formatKbps(s.bitrate) || "Stream";
        pill.title = s.codec ? `${s.codec}` : "stream";
        pill.addEventListener("click", (e) => {
          e.stopPropagation();
          selectedStreamUrl = s.url;
          saveLast();
          playSelected();
          renderQualities();
        });
        qualitiesEl.appendChild(pill);
      }
    }

    function renderList(){
      listEl.innerHTML = "";
      filteredStations.forEach((st, i) => {
        const idxInMain = stations.findIndex(s => s.id === st.id);
        const active = (idxInMain === currentIndex);

        const item = document.createElement("div");
        item.className = "item" + (active ? " active" : "");
        item.addEventListener("click", () => {
          selectStationById(st.id);
          playSelected(true);
        });

        const num = document.createElement("div");
        num.className = "num";
        num.textContent = String(i + 1);
        item.appendChild(num);

        const ml = document.createElement("div");
        ml.className = "mini-logo";
        if(st.logo){
          const img = document.createElement("img");
          img.src = st.logo;
          img.alt = st.name;
          ml.appendChild(img);
        }else{
          ml.textContent = "♪";
        }
        item.appendChild(ml);

        const meta = document.createElement("div");
        meta.className = "item-meta";
        const n = document.createElement("div");
        n.className = "n";
        n.textContent = st.name;
        const s = document.createElement("div");
        s.className = "s";
        s.textContent = "Klik om te spelen";
        meta.appendChild(n);
        meta.appendChild(s);
        item.appendChild(meta);

        const star = document.createElement("button");
        star.className = "star" + (favs.has(st.id) ? " on" : "");
        star.innerHTML = favs.has(st.id) ? "★" : "☆";
        star.title = favs.has(st.id) ? "Unfavorite" : "Favorite";
        star.addEventListener("click", (e) => {
          e.stopPropagation();
          if(favs.has(st.id)) favs.delete(st.id);
          else favs.add(st.id);
          saveFavs();
          renderList();
        });

        item.appendChild(star);
        listEl.appendChild(item);
      });
    }

    function applySearch(){
      const q = (searchEl.value || "").trim().toLowerCase();
      if(!q){
        filteredStations = [...stations];
      }else{
        filteredStations = stations.filter(s => (s.name || "").toLowerCase().includes(q));
      }
      renderList();
    }

    function selectStationById(id){
      const idx = stations.findIndex(s => s.id === id);
      if(idx < 0) return;
      currentIndex = idx;
      currentStation = stations[idx];
      selectedStreamUrl = ""; // reset so we pick best/default again
      stopIcy();
      renderNow();
      loadStreamsForCurrent().then(() => {
        renderQualities();
        renderList();
        saveLast();
      });
    }

    function pickDefaultStream(){
      if(!currentStreams.length) return "";
      if(selectedStreamUrl && currentStreams.some(s => s.url === selectedStreamUrl)){
        return selectedStreamUrl;
      }
      // Prefer higher bitrate if available
      const sorted = [...currentStreams].sort((a,b) => (b.bitrate || 0) - (a.bitrate || 0));
      return sorted[0].url;
    }

    async function loadStreamsForCurrent(){
      // Use fixedStreams as source of truth (works best for your use-case)
      currentStreams = (currentStation.fixedStreams || []).map(x => ({
        url: x.url,
        bitrate: x.bitrate,
        codec: x.codec
      }));

      selectedStreamUrl = pickDefaultStream();
    }

    function proxied(url){
      return STREAM_PROXY_BASE + encodeURIComponent(url);
    }

    async function playSelected(fromUserGesture = false){
      const url = pickDefaultStream();
      if(!url){
        setStatus("err", "Geen stream");
        nowInfo.textContent = "Geen stream gevonden";
        return;
      }

      try{
        setStatus("warn", "Verbinden…");
        nowInfo.textContent = "Verbinden…";

        audio.src = proxied(url);
        audio.load();

        // Autoplay policies: play only reliably after a user gesture.
        // We call playSelected(true) from click actions.
        const p = audio.play();
        if(p) await p;

        setStatus("on", "Speelt");
        playBtn.textContent = "Pause";
        nowInfo.textContent = "Bezig met afspelen…";
        startIcy(url);

        saveLast();
      }catch(err){
        setStatus("err", "Fout");
        playBtn.textContent = "Play";
        nowInfo.textContent = "Kon niet starten (klik opnieuw)";
        if(fromUserGesture){
          // Sometimes a second click works after permission/unlock
        }
      }
    }

    function pauseOrResume(){
      if(audio.paused){
        playSelected(true);
      }else{
        audio.pause();
        setStatus("warn", "Gepauzeerd");
        playBtn.textContent = "Play";
        nowInfo.textContent = "Gepauzeerd";
      }
    }

    function stopAll(){
      audio.pause();
      audio.removeAttribute("src");
      audio.load();
      stopIcy();
      setStatus("", "Idle");
      playBtn.textContent = "Play";
      nowInfo.textContent = "Gestopt";
    }

    function next(){
      const nextIdx = (currentIndex + 1) % stations.length;
      currentIndex = nextIdx;
      currentStation = stations[currentIndex];
      selectedStreamUrl = "";
      renderNow();
      loadStreamsForCurrent().then(() => {
        renderQualities();
        renderList();
        saveLast();
        playSelected(true);
      });
    }

    function prev(){
      const prevIdx = (currentIndex - 1 + stations.length) % stations.length;
      currentIndex = prevIdx;
      currentStation = stations[currentIndex];
      selectedStreamUrl = "";
      renderNow();
      loadStreamsForCurrent().then(() => {
        renderQualities();
        renderList();
        saveLast();
        playSelected(true);
      });
    }

    function stopIcy(){
      if(icyTimer){
        clearInterval(icyTimer);
        icyTimer = null;
      }
    }

    async function fetchIcyTitle(streamUrl){
      try{
        const res = await fetch(ICY_BASE + encodeURIComponent(streamUrl), { cache: "no-store" });
        if(!res.ok) return null;
        const data = await res.json();
        return data?.icyTitle || null;
      }catch{
        return null;
      }
    }

    function startIcy(streamUrl){
      stopIcy();

      // First update quickly
      fetchIcyTitle(streamUrl).then(title => {
        if(title) nowInfo.textContent = title;
        else nowInfo.textContent = "Speelt";
      });

      // Then poll
      icyTimer = setInterval(async () => {
        const title = await fetchIcyTitle(streamUrl);
        if(title) nowInfo.textContent = title;
      }, 12000);
    }

    // Events
    playBtn.addEventListener("click", () => pauseOrResume());
    stopBtn.addEventListener("click", () => stopAll());
    nextBtn.addEventListener("click", () => next());
    prevBtn.addEventListener("click", () => prev());

    audio.addEventListener("ended", () => {
      setStatus("warn", "Einde");
      playBtn.textContent = "Play";
    });
    audio.addEventListener("error", () => {
      setStatus("err", "Stream error");
      playBtn.textContent = "Play";
      nowInfo.textContent = "Stream error (probeer opnieuw)";
    });

    // Volume persistence
    const savedVol = localStorage.getItem(LS_LAST_VOL);
    if(savedVol !== null){
      const v = Math.max(0, Math.min(100, Number(savedVol)));
      vol.value = String(v);
    }
    audio.volume = Number(vol.value) / 100;

    vol.addEventListener("input", () => {
      audio.volume = Number(vol.value) / 100;
      localStorage.setItem(LS_LAST_VOL, String(vol.value));
    });

    // Search
    searchEl.addEventListener("input", applySearch);

    // Init
    loadLast();
    renderNow();
    loadStreamsForCurrent().then(() => {
      renderQualities();
      renderList();
      applySearch();
      setStatus("", "Idle");
    });
  </script>
</body>
</html>
